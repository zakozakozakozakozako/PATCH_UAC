name: ç”Ÿæˆè¡¥ä¸æ–‡ä»¶ï¼ˆä»æŒ‡å®š Commitï¼‰

on:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: "Git ä»“åº“åœ°å€"
        required: true
        default: "https://github.com/cctv18/android_kernel_oneplus_mt6989.git"

      COMMIT_HASH:
        description: "è¦å¯¼å‡ºçš„ Commitï¼ˆå¤šä¸ªç”¨ / åˆ†éš”ï¼ŒæŒ‰é¡ºåº A/B/Cï¼‰"
        required: true

      PATCH_NAME:
        description: "è¾“å‡ºè¡¥ä¸æ–‡ä»¶å"
        required: true
        default: "output.patch"

      REVERSE:
        description: "æ˜¯å¦ç”Ÿæˆåå‘è¡¥ä¸"
        type: boolean
        required: true
        default: false

      CLEAN_HEADER:
        description: "æ˜¯å¦åˆ é™¤è¡¥ä¸ä¸­çš„ commit å¤´éƒ¨ä¿¡æ¯"
        type: boolean
        required: true
        default: true

jobs:
  gen-patch:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ å…‹éš†ä»“åº“
        run: |
          git clone ${{ github.event.inputs.REPO_URL }} repo
          cd repo
          git fetch --all --tags

      - name: ğŸ“Œ æŒ‰é¡ºåºç”Ÿæˆè¡¥ä¸ (A â†’ B â†’ C)
        run: |
          cd repo

          # æŒ‰ "/" è§£æ commit åˆ—è¡¨
          IFS='/' read -ra COMMITS <<< "${{ github.event.inputs.COMMIT_HASH }}"

          # æ¸…ç©ºè¡¥ä¸æ–‡ä»¶
          : > ../${{ github.event.inputs.PATCH_NAME }}

          echo "Commit é¡ºåºä¸ºï¼š${COMMITS[*]}"

          for c in "${COMMITS[@]}"; do
            echo "=========="
            echo "å¤„ç† Commit: $c"
            echo "==========" 
            
            # æ£€æŸ¥ Commit æ˜¯å¦å­˜åœ¨
            if ! git cat-file -e "${c}^{commit}" 2>/dev/null; then
              echo "âŒ é”™è¯¯ï¼šCommit ä¸å­˜åœ¨ï¼š$c"
              exit 1
            fi

            # æŒ‰é¡ºåºè¿½åŠ  patchï¼ˆæˆåŠŸæ‰ç»§ç»­ä¸‹ä¸€ä¸ªï¼‰
            if [ "${{ github.event.inputs.REVERSE }}" = true ]; then
              git show -R "$c" --no-commit-id -p >> ../${{ github.event.inputs.PATCH_NAME }} || exit 1
            else
              git show "$c" --no-commit-id -p >> ../${{ github.event.inputs.PATCH_NAME }} || exit 1
            fi

            echo -e "\n" >> ../${{ github.event.inputs.PATCH_NAME }}

            echo "âœ” å·²æˆåŠŸå¤„ç†ï¼š$c"
          done

      - name: ğŸ§¹ åˆ é™¤ commit å¤´éƒ¨ä¿¡æ¯ (å¯é€‰)
        if: ${{ github.event.inputs.CLEAN_HEADER }}
        run: |
          sed -i '/^commit /,/^diff --git /{ /^diff --git /!d }' ${{ github.event.inputs.PATCH_NAME }}

      - name: ğŸ“¤ ä¸Šä¼ è¡¥ä¸æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.PATCH_NAME }}
          path: ${{ github.event.inputs.PATCH_NAME }}