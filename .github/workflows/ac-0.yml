name: Make Patch From GitHub Folder

on:
  workflow_dispatch:
    inputs:
      FOLDER_URL:
        description: "输入 GitHub 文件夹链接 (tree/...路径)"
        required: true

jobs:
  gen-patch:
    runs-on: ubuntu-latest

    steps:
      - name: Parse URL
        id: parse
        run: |
          raw="${{ github.event.inputs.FOLDER_URL }}"

          # 解码URL（把 %2F 变成 /）
          decoded=$(echo -e "${raw//%/\\x}")

          echo "Decoded URL: $decoded"

          # 仓库 owner/repo
          repo=$(echo "$decoded" | sed -E 's#https://github.com/([^/]+/[^/]+)/.*#\1#')

          # cutoff：tree/ 后面的字符串
          after_tree=$(echo "$decoded" | sed -E 's#.*/tree/(.*)#\1#')

          # branch 是 after_tree 的第一段
          branch=$(echo "$after_tree" | cut -d'/' -f1)

          # 路径是 after_tree 去掉 branch/
          dir=$(echo "$after_tree" | sed -E "s#^${branch}/##")

          echo "repo=$repo" >> $GITHUB_OUTPUT
          echo "branch=$branch" >> $GITHUB_OUTPUT
          echo "dir=$dir" >> $GITHUB_OUTPUT

      - name: Print parsed
        run: |
          echo "Repository: ${{ steps.parse.outputs.repo }}"
          echo "Branch:     ${{ steps.parse.outputs.branch }}"
          echo "Directory:  ${{ steps.parse.outputs.dir }}"

      - name: Clone source repo
        run: |
          git clone --depth=1 \
            -b "${{ steps.parse.outputs.branch }}" \
            "https://github.com/${{ steps.parse.outputs.repo }}.git" \
            src_repo

      - name: Generate patch
        run: |
          mkdir work
          cd work
          git init

          cp -r ../src_repo/${{ steps.parse.outputs.dir }} ./folder

          git add folder
          git diff --cached > ../output.patch

      - name: Upload patch
        uses: actions/upload-artifact@v4
        with:
          name: output-patch
          path: output.patch