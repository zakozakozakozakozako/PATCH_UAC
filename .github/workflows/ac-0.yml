name: Make Patch From GitHub Folder (Auto Branch Detect)

on:
  workflow_dispatch:
    inputs:
      FOLDER_URL:
        description: "输入 GitHub 文件夹链接"
        required: true

jobs:
  gen-patch:
    runs-on: ubuntu-latest

    steps:
      - name: Decode and extract repo + after_tree
        id: parse1
        run: |
          raw="${{ github.event.inputs.FOLDER_URL }}"
          decoded=$(echo -e "${raw//%/\\x}")

          echo "Decoded URL: $decoded"

          repo=$(echo "$decoded" | sed -E 's#https://github.com/([^/]+/[^/]+)/.*#\1#')
          after_tree=$(echo "$decoded" | sed -E 's#.*/tree/(.*)#\1#')

          echo "repo=$repo" >> $GITHUB_OUTPUT
          echo "after_tree=$after_tree" >> $GITHUB_OUTPUT

      - name: Detect correct branch
        id: branchdetect
        run: |
          repo="${{ steps.parse1.outputs.repo }}"
          after_tree="${{ steps.parse1.outputs.after_tree }}"

          # 取 tree 后的所有字段，直到匹配到真实的分支
          for i in 1 2 3 4 5 6 7; do
            try=$(echo "$after_tree" | cut -d'/' -f1-$i)
            echo "Trying branch: $try"

            if git ls-remote --heads https://github.com/$repo.git "$try" &>/dev/null; then
              echo "Found branch: $try"
              echo "branch=$try" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "No matching branch found!"
          exit 1

      - name: Extract directory
        id: parse_dir
        run: |
          dir=$(echo "${{ steps.parse1.outputs.after_tree }}" | sed -E "s#^${{ steps.branchdetect.outputs.branch }}/##")
          echo "dir=$dir" >> $GITHUB_OUTPUT

      - name: Clone repo
        run: |
          git clone --depth=1 \
            -b "${{ steps.branchdetect.outputs.branch }}" \
            "https://github.com/${{ steps.parse1.outputs.repo }}.git" \
            src_repo

      - name: Generate patch
        run: |
          mkdir work
          cd work
          git init

          cp -r ../src_repo/${{ steps.parse_dir.outputs.dir }} ./folder

          git add folder
          git diff --cached > ../output.patch

      - name: Upload patch
        uses: actions/upload-artifact@v4
        with:
          name: patch-output
          path: output.patch