name: Generate Patch From GitHub Folder

on:
  workflow_dispatch:
    inputs:
      FILE_LINK:
        description: "GitHub 文件夹链接（tree/branch/path）"
        required: true
        default: "https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8850/tree/oneplus/sm8850_b_16.0.0_oneplus_15/vendor/oplus/kernel/cpu/sched_ext"

jobs:
  make-patch:
    runs-on: ubuntu-latest

    steps:
    - name: Parse link
      id: parse
      run: |
        LINK="${{ github.event.inputs.FILE_LINK }}"

        REPO_URL="$(echo "$LINK" | sed -E 's|/tree/.*||')"
        AFTER_TREE="$(echo "$LINK" | sed -E 's|.*tree/||')"

        BRANCH="$(echo "$AFTER_TREE" | sed -E 's|(vendor/.*)||')"
        BRANCH="${BRANCH%/}"

        SUBDIR="$(echo "$AFTER_TREE" | sed -E "s|^$BRANCH/||")"

        echo "repo=$REPO_URL" >> $GITHUB_OUTPUT
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "subdir=$SUBDIR" >> $GITHUB_OUTPUT

    - name: Sparse checkout target folder
      run: |
        REPO="${{ steps.parse.outputs.repo }}"
        BRANCH="${{ steps.parse.outputs.branch }}"
        SUBDIR="${{ steps.parse.outputs.subdir }}"

        git clone --no-checkout "$REPO.git" repo
        cd repo
        git fetch origin "$BRANCH"

        git sparse-checkout init --cone
        git sparse-checkout set "$SUBDIR"
        git checkout "$BRANCH"

    - name: Copy files out
      run: |
        SUBDIR="${{ steps.parse.outputs.subdir }}"
        mkdir extracted
        cp -r repo/"$SUBDIR" extracted/

    - name: Generate patch (all files = added)
      run: |
        cd extracted

        git init
        git config user.email "bot@example.com"
        git config user.name "patch-bot"

        git add .
        git diff --cached > ../folder.patch

    - name: Upload patch
      uses: actions/upload-artifact@v4
      with:
        name: folder-patch
        path: folder.patch