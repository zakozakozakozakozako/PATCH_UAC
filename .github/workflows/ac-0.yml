name: Download GitHub Folder (Any Folder Auto Fetch)

on:
  workflow_dispatch:
    inputs:
      FILE_LINK:
        description: "请输入 GitHub 文件夹链接 (tree/<branch>/<path>)"
        required: true
        default: "https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8850/tree/oneplus/sm8850_b_16.0.0_oneplus_15/vendor/oplus/kernel/cpu/sched_ext"

jobs:
  fetch-folder:
    runs-on: ubuntu-latest

    steps:
    - name: Parse repo, branch and subdir
      id: parse
      run: |
        LINK="${{ github.event.inputs.FILE_LINK }}"
        echo "Input link: $LINK"

        #### 解析仓库 URL ####
        REPO_URL="$(echo "$LINK" | sed -E 's|/tree/.*||')"
        echo "repo-url=$REPO_URL" >> $GITHUB_OUTPUT

        #### 提取 tree 后部分 ####
        AFTER_TREE="$(echo "$LINK" | sed -E 's|.*tree/||')"

        #### 分支名称 = tree 后 第一段 ####
        BRANCH="$(echo "$AFTER_TREE" | cut -d'/' -f1)"

        #### 子目录路径（去掉 branch/）####
        SUBDIR="$(echo "$AFTER_TREE" | sed -E "s|^[^/]*/||")"

        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "subdir=$SUBDIR" >> $GITHUB_OUTPUT

        echo "--- Parsed ---"
        echo "Repo URL: $REPO_URL"
        echo "Branch:   $BRANCH"
        echo "Folder:   $SUBDIR"

    - name: Sparse checkout folder
      run: |
        REPO="${{ steps.parse.outputs.repo-url }}"
        BRANCH="${{ steps.parse.outputs.branch }}"
        SUBDIR="${{ steps.parse.outputs.subdir }}"

        echo "Cloning $REPO (no checkout)..."
        git clone --no-checkout "$REPO.git" source
        cd source

        echo "Fetching branch: $BRANCH"
        git fetch origin "$BRANCH"

        git sparse-checkout init --cone
        git sparse-checkout set "$SUBDIR"

        echo "Checking out..."
        git checkout "$BRANCH"

    - name: Copy folder to output
      run: |
        SUBDIR="${{ steps.parse.outputs.subdir }}"
        DIR_NAME=$(basename "$SUBDIR")

        mkdir -p downloaded
        cp -r source/"$SUBDIR" "downloaded/$DIR_NAME"

        echo "Saved to ./downloaded/$DIR_NAME"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: downloaded-folder
        path: downloaded