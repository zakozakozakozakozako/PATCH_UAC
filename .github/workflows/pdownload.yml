name: Download GitHub Folder (sched_ext or any folder)

on:
  workflow_dispatch:
    inputs:
      FILE_LINK:
        description: "请输入 GitHub 文件夹链接 (tree/xxx/<path>)"
        required: true
        default: "https://github.com/OnePlusOSS/android_kernel_modules_and_devicetree_oneplus_sm8850/tree/oneplus/sm8850_b_16.0.0_oneplus_15/vendor/oplus/kernel/cpu/sched_ext"

jobs:
  fetch-folder:
    runs-on: ubuntu-latest

    steps:
    - name: Parse repo URL, branch, folder
      id: parse
      run: |
        LINK="${{ github.event.inputs.FILE_LINK }}"
        echo "Input link: $LINK"

        #### 1. 仓库 URL ####
        REPO_URL="$(echo "$LINK" | sed -E 's|/tree/.*||')"
        echo "repo-url=$REPO_URL" >> $GITHUB_OUTPUT

        #### 2. tree 后部分 (branch + folder) ####
        AFTER_TREE="$(echo "$LINK" | sed -E 's|.*tree/||')"

        #### 3. OnePlus 分支规律：从开头持续匹配到 vendor/ 前 ####
        # 示例： oneplus/sm8850_b_16.0.0_oneplus_15/vendor/oplus/kernel/xxx
        BRANCH="$(echo "$AFTER_TREE" | sed -E 's|(vendor/.*)||')"
        BRANCH="${BRANCH%/}"        # 去掉末尾 /（如果有）

        #### 4. 子目录（branch 后面那段） ####
        SUBDIR="$(echo "$AFTER_TREE" | sed -E "s|^$BRANCH/||")"

        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "subdir=$SUBDIR" >> $GITHUB_OUTPUT

        echo "--- Parsed ---"
        echo "Repo URL: $REPO_URL"
        echo "Branch:   $BRANCH"
        echo "Folder:   $SUBDIR"

    - name: Sparse checkout this folder
      run: |
        REPO="${{ steps.parse.outputs.repo-url }}"
        BRANCH="${{ steps.parse.outputs.branch }}"
        SUBDIR="${{ steps.parse.outputs.subdir }}"

        echo "Cloning repo: $REPO"
        git clone --no-checkout "$REPO.git" source
        cd source

        echo "Fetching branch: $BRANCH"
        git fetch origin "$BRANCH"

        echo "Sparse-checkout folder: $SUBDIR"
        git sparse-checkout init --cone
        git sparse-checkout set "$SUBDIR"

        echo "Checking out..."
        git checkout "$BRANCH"

    - name: Copy folder to output
      run: |
        SUBDIR="${{ steps.parse.outputs.subdir }}"
        DIR_NAME=$(basename "$SUBDIR")

        mkdir -p downloaded
        cp -r source/"$SUBDIR" "downloaded/$DIR_NAME"

        echo "Saved to ./downloaded/$DIR_NAME"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: downloaded-folder
        path: downloaded